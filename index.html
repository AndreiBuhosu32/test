<!DOCTYPE html>
<html>
<head>
    <title>Salesforce Authenticated Chat Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; max-width: 500px; }
        h1 { color: #0176d3; margin-bottom: 10px; }
        .status-badge { display: inline-block; padding: 8px 16px; border-radius: 20px; background: #ecebea; font-weight: bold; margin-top: 20px; }
        #status-text { color: #514f4d; }
        .success { background: #04844b !important; color: white !important; }
        .error { background: #ea001e !important; color: white !important; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Identity Handshake Test</h1>
        <p>Testing domain: <strong>lvh.me:5500</strong></p>
        <div id="status-badge" class="status-badge">
            <span id="status-text">ðŸ”„ Initializing Salesforce...</span>
        </div>
        <p style="font-size: 0.8em; color: #747474; margin-top: 20px;">
            If the chat icon doesn't appear, ensure you are "Available" in Salesforce Omni-Channel.
        </p>
    </div>

    <script type='text/javascript'>
        // 1. YOUR IDENTITY TOKEN (Generated with kid: TestKey1 and iss: my-local-test-issuer)
        const MY_TOKEN = "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6IlRlc3RLZXkxIn0.eyJpc3MiOiJteS1sb2NhbC10ZXN0LWlzc3VlciIsInN1YiI6InRlc3R1c2VyQGV4YW1wbGUuY29tIiwiZXhwIjoxOTk5OTk5OTk5fQ.n6MtGpINr41deswqhD4BTcSD8Vyih6SvtnhQ3RbQazZpkZuhL2CLen13ZfEbeeBRFtw_0d8i7kB2pO95134t6uox3sJvTUlStzzYIQITQRw7kidIyKrD6Wuo3pxWohz1oVJzidazY92AQFU0KM7k5fI3OXiAwwTdVSF1W3EJwsbuDb1WCzZkIEFB68r7vrNzJK6k6_09FEpwb5GCP5JmeP7tFF1TZhiRTJ3uMhimZVtZgw_7TVXtS4p0UujGrreDyrcWYkg4p6bRuCKl2B9V86-6iIlO-Ut97THOGcLAqDvgq7MfGr83jfr4BKEvQvLIGZLu7knE6-ZQvHBICwZ_KA";

        function initEmbeddedMessaging() {
            try {
                embeddedservice_bootstrap.settings.language = 'en_US';

                // Initialize with your 'lv' deployment settings
                embeddedservice_bootstrap.init(
                    '00DS900000Dgm1o',
                    'lv',
                    'https://quartix--snowdrop.sandbox.my.site.com/ESWlv1769696522963',
                    {
                        scrt2URL: 'https://quartix--snowdrop.sandbox.my.salesforce-scrt.com'
                    }
                );
            } catch (err) {
                console.error('Error loading Embedded Messaging: ', err);
                updateStatus("âŒ Load Error", "error");
            }
        };

        function updateStatus(text, className) {
            const badge = document.getElementById('status-badge');
            const statusText = document.getElementById('status-text');
            statusText.innerText = text;
            if (className) badge.classList.add(className);
        }

window.addEventListener("onEmbeddedMessagingReady", () => {
    console.log("ðŸŸ¢ ON_READY: Salesforce Engine Loaded!");
    document.getElementById('status').innerText = "Authenticating user...";

    embeddedservice_bootstrap.userVerificationAPI.setIdentityToken({
        identityTokenType: "JWT",
        identityToken: MY_TOKEN
    }).then(() => {
        console.log("âœ… SUCCESS: JWT Accepted by Salesforce.");
        document.getElementById('status').innerText = "Identity Verified!";
        
        // Force the chat button to appear immediately
        embeddedservice_bootstrap.util.showChatButton();
    }).catch((err) => {
        console.error("âŒ AUTH FAILURE: Check your JWT Key ID (kid) and Issuer (iss).", err);
        document.getElementById('status').innerText = "Auth Failed. Check console.";
    });
});

        // 3. OFFLINE SUPPORT LOGIC
        window.addEventListener("onEmbeddedMessagingOfflineSupportReady", () => {
            console.log("ðŸŸ  OFFLINE: Agents are away. Showing Case form.");
            updateStatus("ðŸŸ  Offline Mode Active", "");
        });
    </script>

    <script type='text/javascript' 
            src='https://quartix--snowdrop.sandbox.my.site.com/ESWlv1769696522963/assets/js/bootstrap.min.js' 
            onload='initEmbeddedMessaging()'>
    </script>

</body>
</html>